# 레디스에서 데이터를 영구 저장하기

- 레디스 데이터는 메모리에 상주하며, 서버 장애 시 데이터 손실 가능성이 있음.
- 복제는 가용성을 위한 것이며, 오류나 실수로 발생한 수정/삭제는 복제본에도 그대로 반영됨.
- 영구 저장이 필요한 경우 디스크 백업이 필요하며, RDB와 AOF 방식이 있음.

## AOF 파일

- 모든 쓰기 작업을 기록하며, 데이터 변경 내역을 저장.
- RDB보다 크기가 크며, 주기적인 재구성 필요.

## RDB 파일

- 특정 시점의 메모리 데이터를 스냅샷으로 저장.
- 빠른 복원 가능, 특정 시점 복구는 불가능.

## RDB와 AOF 동시 사용

- 안전성을 위해 두 가지 백업 방식을 병행하는 것이 권장됨.

### 데이터 복원 가능 시점

- 서버 재시작 시에만 복원 가능.

### AOF, RDB 파일 로드 방식

- 서버 재시작 시 파일이 존재하면 AOF 또는 RDB 파일을 로드.
- AOF 파일이 존재할 경우 우선적으로 사용됨.

### RDB 방식의 데이터 백업

### RDB 파일 생성 방법

- 설정 파일에서 특정 조건으로 자동 생성하거나 커맨드로 수동 생성 가능.
- 복제 사용 시 자동으로 생성되어 복제본에 전달됨.

### SAVE, BGSAVE 커맨드

- **SAVE**: 동기식 방식으로 실행, 운영 환경에서는 사용 권장하지 않음.
- **BGSAVE**: 백그라운드에서 자식 프로세스를 이용해 비동기적으로 RDB 파일 생성.

### 복제를 사용할 경우 RDB 생성

- 복제 요청 시 마스터 노드에서 RDB 생성 후 복제본에 전송.
- 복제 중단 후 재연결 시에도 RDB 파일 재생성 가능.

### AOF 방식의 데이터 백업

- 모든 쓰기 작업을 로그로 기록하며 실수한 커맨드 삭제 후 복구 가능.
- AOF 파일은 기본적으로 `appendonly.aof`로 저장.
    
    ### AOF 파일 재구성
    
    - AOF 파일 크기를 관리하기 위해 주기적으로 압축(재구성) 필요.
    - 설정 파일에서 자동으로 재구성하거나 커맨드를 이용해 수동 재구성 가능.

### 백업 시 주의 사항

- 인스턴스의 `maxmemory`는 서버 메모리보다 여유 있게 설정 권장.
- RDB 파일 저장 또는 AOF 재구성 시 자식 프로세스가 메모리를 복사해 작업을 수행(Copy-On-Write 방식).
- 서버 메모리 크기에 따른 권장 maxmemory 값

| **RAM** | **Maxmemory** | **비율** |
| --- | --- | --- |
| 2G | 638MB | 33% |
| 4G | 2048MB | 50% |
| 7G | 4779MB | 58% |
| 16G | 10240MB | 63% |
| 32G | 21163MB | 65% |
| 64G | 43008MB | 66% |