### 센티널 설정이 없다면

- 복제 구조만 셋팅한 뒤, 운영 환경에서 장애를 마주한다면 아래와 같은 과정을 거쳐야 복구할 수 있다.
1. 복제본 노드에 직접 접속한 뒤 REPLICA OF NO ONE 커맨드를 입력하여 전용상태 해제
2. 애플리케이션 코드에서 레디스의 엔드포인트를 복제본 IP로 변경
3. 배포

따라서 장애 처리가 지연 돼 곧바로 서비스 기능의 문제로 이어질 수 있다.

레디스를 look aside 구성의 캐시로 사용했을 경우, 원본 데이터 소스에 부하를 줄 수 있다.

### 센티널

- 센티널의 자동 페일오버 기능을 사용하면 위와 같은 문제가 발생했을 때 레디스를 계속 사용할 수 있게 하여 다운타임을 최소화할 수 있다.

센티널의 제공 기능

- 모니터링 : 마스터, 복제본 인스턴스의 상태를 실시간 확인
- 자동페일오버 : 마스터의 비정상 상태를 감지하여, 복제본 중 하나를 마스터로 승격
- 인스턴스 구성 정보 안내 : 클라이언트에게 현재 구성에서의 마스터 정보를제공

> SPOF 하나의 서비스가 문제가 발생했을 때 전체 시스템이 영향을 받는 지점을 뜻함.
> 

최대 3대 이상일 때 정상적으로 동작, 하나의 센티널에 이상이 있더다로 다른 센티널이 계속해서 역할을 수행한다.

쿼럼, 마스터가 비정상 동작을 한다는 것에 동의하는 센티널 수로, 쿼럼을 만족하는 경우 페일오버를 시작한다. 

### 센티널 프로세스 실행

1. 센티널 프로세스를 실행하기 전 마스터와 복제본 노드를 연결시킨다.

```jsx
REPLICAOF 192.168.0.11 6379
```

1. setniel.conf 파일을 작성한다.

```jsx
port 26379
setniel monitor master-test 192.168.0.11 6379 2 //모니터링할 마스터이름 아이피 포트 쿼럼수
```

1. 실행하기

```jsx
redis-sentinel /path/to/sentinel.conf
redis-server /path/to/sentinel.conf --sentinel
```

1. 접속하기

```jsx
redis-cli -p 센티널포트

SENTINEL master 마스터이름 //마스터 정보 및 마스터에 연결된 복제본 정보
SENTINEL replicas 마스터이름 //복제본 자세한 정보
SENTINEL sentinels 마스터이름 //마스터에 연결된 센티널 정보
SENTINEL ckquorum 마스터이름 //쿼럼 체크
```

### 페일오버 테스트

구성한 뒤, 두 가지 방법으로 페일오버를 발생시켜 볼 수 있다.

1. 커맨드를 이용한 페일오버 발생

```jsx
SETINEL FAILOVER 마스터이름
```

1. 마스터 동작을 중지시켜 페일오버 발생

```jsx
redis-cli -h 마스터호스트 -p 포트 shutdown
```

- down-after-milliseconds센티널이 마스터가 장애가 발생했다고 판단하는 시간 옵션, 기본 30초

### 센티널 운영

마스터에 패스워드가 설정되어 있으면 센티널도 설정해야함.

```jsx
sentinel auth-pass 마스터이름 비밀번호
```

복제본 우선순위

```jsx
replica-priority //가장 작은 값이 선정됨,
```

기본값 100, 단 0인 복제본은 절대 마스터로 선정되지 않음.

운영중에 센티널 옵션을 변경 할 수 있다. 

단, 각각의 센티널에 모두 설정을 적용해야하고 하나 변경했다고 전파되진 않는다.

바꿀 수 있는 설정

1. 모니터링할 마스터
2. 모니터링 끊기
3. 다운 판단 시간
4. 쿼럼 수
5. 고유 설정 값

### 센티널 초기화

특정 마스터에 대해 저장되어있는 정보를 초기화, 해당 서버가 더 이상 사용되지 않는다고 판단할 때 사용

```jsx
SENTIEL RESET 마스터이름
```

### 자동 페일오버 과정

1. 마스터의 장애 상황 감지
2. sdown, odown 실패 상태로 전환
3. 에포크 값 증가 : 버전같은 개념
4. 센티널 리더 선출
5. 복제본 선정 후 마스터로 승격
6. 복제 연결 변경
7. 장애조치 완료

### 스플릿 브레인 현상

네트워크 파티션 이슈로 인해 분산 환경의 데이터 저장소가 끊어지고, 끊긴 두 부분이 각각을 정상적인 서비스라고 판단하는 현상을 의미한다.

장애는 발생하지 않고 단지 네트워크 단절만 일어난 경우, 발생한다. 

복구 후에는 백업데이터가 기존 마스터가 했던 모든 데이터가 유실된다 .
