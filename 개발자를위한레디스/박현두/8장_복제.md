###복제

* 가용성은 일반적으로 서비스의 안정성을 측정하는 데 사용하는 지표다.

* 레디스에서 고가용성을 확보하기 위해서는 두가지 방법이 있다.

  * 복제 : 마스터 노드의 데이터를 슬레이브 노드에 실시간으로 복제하는 방법
  * 자동 페일오버 : 마스터 노드에서 장애가 발생했을 때 클라이언트의 요청을 슬레이브 노드로 자동으로 전환하는 방법
  
* 복제 노드를 추천하는 이유
  1. 언제든지 고장날 수 있어, 마스터가 다운됐을 때 대신 사용할 여분의 노드가 필요하다.
  2. 트래픽을 분산시킬 수 있다.
  3. 매번 운영중인 데이터를 백업하는 것은 부담스렁누 작업이다.

* 복제 구조 구성하기

```redis
    REPLICAOF <master_ip> <master_port>
```

![img.png](img.png)

* 항상 하나의 마스터 노드가 존재하며, 업데이드 커맨드는 마스터 노드에서만 수행할 수 있다.
* 복제 노드는 읽기만 가능하다.

* 패스워드 설정
    
```redis
    CONFIG SET masterauth <password>
    CONFIG REWRITE 
```

* 복제 메커니즘
    * 7버전 이후
    * repl-diskless-sync : 기본값 yes 디스크를 사용하지 않고 복제
    * repl-diskless-load : 기본값 disabled RDB 스냅숏 데이터를 바로 메모리에 로드하지 않고 디스크에 저장
    ![img_1.png](img_1.png)  
    * 하나의 복제가 연결중에 다른 복제본은 연결할 수 없음.
  ```redis
    repl-diskless-sync-delay 5 # 5초 지연 
  ```
* 비동기 방식으로 동작하는 복제 연결
  * 연결 이후에는 비동기 방식으로 데이터를 전달한다.
* 복제 ID
  * 모든 레디스 인스턴스는 복제 ID를 가지고 있다.
  ```redis
    INFO REPLICATION # 복제 ID 확인
  ```
  결과 예시
 ![img_2.png](img_2.png)

* 부분 재동기화
  * 복제 연결이 끊길 때 마다 전체 데이터를 다시 복제하는 것은 비효율적이다.
  * 이를 방지하기 위해 부분 재동기화를 사용한다.
  * 마스터는 커넥션 유실을 대비해 백로그 버퍼라는 메모리 공간에 복제본에 전달할 커맨들를 저장하고 있다.
  * 하나의 복제 그룹에서 replication id 와 오프셋을 이용하면 복제본이 마스터의 어느 시점까지의 데이터를 수신했는지 확인할 수 있다.
  * 이를 통해 필요한 부분만 재동기화를 수행할 수 있다.
  * 하지만 마스터의 백로그 버퍼에 데이터가 남아 있지 않거나 복제본 ID가 마스터와 일치하지 않는 경우 전체 재동기화를 수행한다.
* Secondary 복제 ID
  * 한 복제 그룹 내의 레디스는 모든 동일한 복제 ID를 가진다.
  * A가 장애가 발생하여 B가 마스터로 승격되면 B는 새로운 복제 ID를 가진다.
  * 복제 ID가 동일하다는 것은 동일한 데이터를 가지고 있다는 것을 의미한다.

![img_3.png](img_3.png)


* 백업을 사용하지 않는 경우에서의 데이터 복제
  * 레디스에서 복제를 사용하는 경우 마스터와 복제본에서 백업 기능을 사용하는 것이 좋다.
  * 만약 이 기능을 사용하지 않으려면 재부팅 후 레디스가 자동으로 재시작되지 않도록 설정하는 것이 좋다.
  * 마스터에서 장애가 발생한 뒤 백업 없이 재부팅하는 경우 데이터가 유실된다.
