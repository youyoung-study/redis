### 스케일 업

- 수직 확장
- 하드웨어 사양을 높이는 것 ex) 메모리 증가

### 스케일 아웃

- 수평 확장

앞의 내용과 달리 마스터를 확장하는 것 최대 1000개 까지 가능

모든 노드가 키가 저장되어있는 노드를 알고 있고 캐싱하고 있어서 키를 찾아오는 시간을 단축하고 있다.

클러스터 내의 노드들은 클러스터 버스라는 독립적인 통신을 이용한다.

일반적으로 설정을 하지 않으면 일반 포트에 10000을 더한 포트를 이용하여 서로 통신한다.

### 레디스 클러스터 동작 방법

- 해시 슬록을 이용한 데이터 샤딩

클러스터 구조에서 모든 데이터는 해시슬롯에 저장된다.

각 마스터 노드가 나눠서 해시 슬롯을 가지고 있다.

모든 키는 하나의 해시슬롯을 가지고 있고 마스터 노드내에서 옮겨질 수 있다.

이러한 특성으로 추가 삭제에 자유롭다.

- 해시태그

클러스터를 사용하면 다중 키 커맨드를 사용할 수 없다.

각 키가 서로 다른 해시슬롯에 저장되어 있고, 클러스터가 키를 가진 마스터로 리다이렉션시키기 때문에 여러 키를 한번에 조회할 수 없다.

이때 해시 태그를 사용하면 가능하다.

```bash
user:{123}:profile
user:{123}:account
```

대괄호 사이에 123이라는 동일한 값을 가지고 있으면, 동일한 마스터에 저장된다는 것을 보장할 수 있다.

다만 해시슬롯을 이용하면 특정 마스터에 데이터가 몰릴 수 있어 모니터링이 필요하다.

### 자동 재구성

센티널과 마찬가지로 클러스터 구조에서도 복제와 자동 페일오버를 이용해 고가용성을 확보할 수 있다.

다만 센티널과 달리 일반 레디스 노드가 서로를 가시한다.

두 가지 재구성

1. 마스터 노드에 장애가 발생했을때 복제본 노드를 마스터로 승격시키는 자동 페일오버
2. 복제본을 다른 마스터에 연결시키는 복제본 마이그레이션

- 하나라도 정상이 아니면 전체 상태가 fail

```bash
cluster-require-full-coverage yes
```

- 복제본 노드의 불균형도 레디스는 해결해준다.

```bash
cluster-allow-replica-migration yes
cluster-migration-barrier 1
```

가장 많은 수의 복제본을 가진 마스터에서 fail상태가 아닌 가장 작은 복제본이 이동된다.

### 클러스터 초기화

```bash
cluster-enabled yes

redis-cli -cluster create [host:port] --cluster-replicas 1

```

### 클러스터 상태 확인하기

```bash
redis-cli cluster nodes //현재 클러스터의 상태 확인
```

### 아무런 옵션 없이 키를 set 하려고하면 요청해야할 마스터정보를 준다.

jedis, redission등의 클라이언트는 클러스터 모드를 지원한다.

### 클러스터 리샤딩

마스터 노드가 가지고 있는 일부 해시슬롯을 다른 마스터로 이동하는 것을 리샤딩이라고 한다.

```bash
redis-cli --cluster reshared ip port
```

### 운영 중에 실시간으로 노드를 추가하거나 제거할 수 있다.

### 복제본을 이용하여 읽기 성능을 향상 시킬 수 있다.

마스터 노드에 부하가 집중되는 경우, 쓰는 커넥션은 마스터에, 읽는 커넥션은 복제본에 수행할 수 있다.

### 클러스터 동작 방법

1. 하트비트 패킷

클러스터 노드들은 지속적으로 서로의 상태를 확인하기 위해 ping pong 한다. 이를 하트비트 패킷이라고 한다.

패캣 정보는 노드 아이디, 현재에포크,구성에포크, 노드플래그, 비트맵, tcp포트, 클러스터 포트, 클러스터 상태, 마스터 노드 id를 가진다.

1. 해시 슬롯 구성이 전파되는 방법

가장 중요한 클러스터 기능은 하나의 커맨드에서 사용한 키의 해시슬롯이 정확히 어디에 있는지 위치를 알려주는 것 이다.

하트비트 패킷과 업데이트 메시지 두가지 방법으로 구성을 전파한다.

초기에 null로 정보를 가지고 있고

패킷이 들어올 경우 업데이트된다. 에포크가 변경된 경우 해당 키의 정보를 변경한다.

1. 노드 핸드셰이크

노드가 클러스터에 합류하기 위해서는 clsuter meet 커맨드를 사용해 매시 형태로 연결된다. 방향성이 없기 때문에 한번만 연결하면된다.

1. 리디렉션

리디렉션에는 moved와 ask 두가지가 있다.

moved는 특정 마스터로 요청을 보내라라는 의미이고,

ask는 이번요청만 다른 마스터로 요청을 보내고 다음 요청은 나한테 다시 보내란 의미이다.

1. 장애감지와 페일오버

특정 노드에 timeout 시간 이상 도달할 수 없는 경우 해당 노드를 PFAIL 표시를 한다.

실제로 마스터가 장애가 발생했다고 인지해서 페일오버를 트리거 시키기 위해서는 FAIL 상태여야한다. PFAIL처리를 하게 되면 다른 노드로 부터 해당 노드에 대한 정보를 받고 다른 노드도 PFAlL 또는 FAIL인 경우 페일오버를 시작한다.
