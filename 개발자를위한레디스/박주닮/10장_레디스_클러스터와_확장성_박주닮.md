### 스케일 업과 스케일 아웃의 차이점

**스케일업**

- 서버의 하드웨어를 높은 사양으로 업그레이드
- 수직 확장 이라고도 함

**스케일 아웃**

- 장비를 추가해 시스템을 확장시키는 방식
- 수평 확장이라고도함

레디스는 단일 스레드로 동작하기 떄문에 서버에 CPU를 추가한다고 해도 여러 CPU 코어를 동시에 활용할 수 없다.

→ 데이터를 분할해 관리하면 다수의 서버에서 요청을 병렬로 처리할 수 있다.

### 레디스 클러스터의 기능

1. **데이터 샤딩**
- 데이터 저장소를 수평 확장하며 여러 서버 간에 데이터를 분할하는 데이터베이스 아키텍처 패턴

1. **고가용성**
- 클러스터는 각각 최소 3대의 마스터, 복제본 노드를 갖도록 구성하는 것이 일반적
- 하나의 클러스터 구성에 속한 각 노드는 서로를 모니터링.
- 자동 페일오버와 복제본 마이그레이션

### 레디스 클러스터 동작 방법

- 해시슬롯을 이용한 데이터 샤딩
    - 클러스터 구조에서 모든 데이터는 해시슬롯에 저장됨
    - 레디스에 입력되는 모든 키는 하나의 해시슬롯에 매핑됨

### 해시태그

- 클러스터를 사용할 때에는 다중 키 커맨드를 사용할 수 없는데, 해시테그라는 기능을 사용하면 이런 문제를 해결할 수 있다.
- 클러스터에서 데이터는 키를 랜덤으로 해시슬롯에 배정하는데 키에 대괄호를 사용하면 전체 키가 아닌 대괄호 사이에 있는 값을 이용해 해시될 수 있다. 이를 해시태그라 한다.

```java
user:{123}:profile
user:{123}:account
```

- 위의 두 키는 대괄호 사이에 123 이라는 동일한 값을 갖고 있기 때문에 같은 해시슬롯, 즉 같은 마스터에 저장된다는 것이 보장된다.

### 레디스 클러스터 실행하기

- 레디스를 클러스터 모드로 사용하려면 최소 3개의 마스터 노드가 있어야 함
- 보통 실제 운영 목적으로 사용할 때는 3개의 마스터에 각각 복제본을 추가해 총 6개의 노드로 클러스터를 구성하는 것이 일반적임

클러스터 초기화

```java
cluster-enabled yes
```

- 클러스터 모드로 변경

```java
redis-cli -cluster create [host:port] --cluster-replicas 1
```

- create 옵션을 이용해 새로운 클러스터를 생성

```java
$ src/redis-cli --cluster create 192.168.0.11:6379 192.168.0.22:6379 192.168.0.33:6379 192.168.0.44:6379 192.198.0.55:6379 192.168.0.66:6379 --cluster-replicas 1 -a nhncloud
```

- 입력한 순서대로 3개의 노드는 마스터, 나머지 노드는 복제본이 되도록 구성
- 정상적인 초기화가 완료되면 [OK] All 16384 slots covered. 커맨드가 떨어지며 생성이 종료됨

### 페일오버 테스트

---

### 커맨드를 이용한 페일오버 발생(수동 페일오버)

- 수동으로 페일오버 시키려면 페일오버시키고자 하는 마스터에 1개 이상의 복제본이 연결돼 있어야 한다.
- 페일오버를 발생시킬 복제본 노드에서 CLUSTER FAILORVER 커맨드를 실행하면 페일오버를 발생시킬 수 있다.
- 수동 페일오버가 진행되는 동안 기존 마스터에 연결된 클라이언트는 잠시 블락된다.
- 페일어보를 시작하기 전 복제 딜레이를 기다린 뒤, 마스터의 복제 오프셋을 복제본이 따라잡는 작업이 완료되면 페일오버를 시작한다.
- 페일오버가 완료되면 클러스터의 정보를 변경하고, 모든 작업이 완료되면 클라이언트는 새로운 마스터로 리디렉션된다.

### 마스터 동작을 중지시켜 페일오버 발생(자동 페일오버)

- 마스터의 상태가 정상이 아닐 경우 다른 노드에서 이를 인지할 수 잇는지 확인할 수 있다.

```java
$ redis-cli -h <master-host> -p <master-port> shutdown
```

- 클러스터 구조에서 복제본은 redis.conf에 지정한 cluster-node-timeout 시간 동안 마스터에서 응답이 오지 않으면 마스터의 상태가 정상적이지 않다고 판단해 페일오버를 트리거한다.
    - 해당 옵션의 기본값은 15,000밀리세컨드, 즉 15초이므로 복제본은 15초동안 마스터에서 응답을 받지 못했을 때 마스터의 상태가 비정상이라 판단해 페일오버를 진행시킨다.

### 복제본을 이용한 읽기 성능 향상

```java
$ redis-cli -h 192.168.0.55 -c
192.168.0.55:6379> readonly
OK
192.168.0.55:6379> get hello
"world"
```

- 복제본으로 맺어지는 커넥션을 READONLY 모드로 변경해 클라이언트가 복제본 노드에 있는 데이터를 직접 읽을 수 있게 할 수 있다.

### 레디스 클러스터 동작 방법

클러스터에서 해시슬롯의 구성은 두 가지 방법으로 전파된다.

- 하트비트 패킷
    - 레디스 클러스터 노드들은 지속적으로 서로의 상태를 확인하기 위해 PING,PONG 패킷을 주고받는다.
    - 이 두 패킷을 묶어서 하트비트 패킷이라 하며 일반적으로 클러스터가 주고받는 유형의 패킷에 가십 섹션이 추가된 형태를 띤다.
- 업데이트 메시지
    - 하트비트 패킷에는 발신하는 노드의 구성 에포크 값이 포함돼 있다.
    - 패킷을 보낸 노드의 에포크 값이 오래됐다면 해당 패킷을 받은 노드는 신규 에포크의 구성 정보를 포함한 업데이트 메시지를 노드에 보내 하트비트 패킷을 보낸 노드의 해시슬롯 구성을 업데이트 한다.
