### 고가용성 필요성

- 레디스를 캐시로 사용하고 있다고 가정했을경우, 레디스 서버에 장애가 나면 캐시를 바라보던 클라이언트들의 요청이 원본 데이터베이스에 요청을 보낼 수 있기 때문에 서버 부하가 급증할 수 있다.

### 센티널(Sentinel)이란?

- 레디스의 자체 고가용성 기능
- 센티널의 기능
    - 모니터링
        - 마스터, 복제본 인스턴스의 상태를 실시간으로 확인한다.
    - 자동 페일오버
        - 마스터의 비정상 상태를 감지해 정상 상태의 복제본 중 하나를 마스터로 승격시킨다. 기존 마스터에 연결된 복제본은 새롭게 승격된 마스터에 연결된다.
    - 인스턴스 구성 정보 안내
        - 센티널은 클라이언트에게 현재 구성에서의 마스터 정보를 알려준다.
        - 페일오버가 발생하면 변경된 마스터 정보를 재전달하기 때문에 페일오버가 발생하더라도 레디스의 엔드포인트 정보를 변경할 필요가 없다.

sentinel.conf

```bash
port 26379
sentinel monitor master-test 192.168.0.11 6379 2
```

port = 센티널 프로세스가 실행될 포트

sentinel monitor = 모니터링할 마스터의 이름을 지정하고 마스터에 이름을 부여하며, 쿼럼 값을 지정한다.(쿼럼 = 2)

복제본 정보는 직접 입력하지 않아도 센티널 프로세스가 마스터에 연결된 복제본을 자동으로 찾아내는 과정을 거친다.

센티널 인스턴스를 실행시킬 모든 서버에서 해당 파일을 작성한 뒤, 각각 인스턴스를 시작시켜야 한다.

```bash
# redis-sentinel을 이용하는 방법
redis-sentinel /path/to/sentinel.conf

# redis-server를 이용하는 방법
redis-server /path/to/sentinel.conf --sentinel
```

쿼럼 값은 정상을 판단하기 위해 있음

→ 센티널 3대있다고 가정

→ 1대의 센티널에 문제가 생겨 정상 센티널은 2대가 됨

→ 위의 쿼럼을 2로 했기때문에 정상적인 개수가 2 이상이라 정상으로 판단.

→ 만약 2대가 문제가 생겨서 1대만 정상인 상태가 된다면

→ 정상적인 센티널의 대수가 쿼럼보다 작기 때문에 마스터 노드에 장애가 발생해도 투표를 진행할 수 없어 페일오버를 자동으로 실행할 수 없다.

### 페일오버 테스트 방법

- 두 가지 방법을 이용해 페일오버를 발생시킬 수 있음
1. 커맨드를 이용한 페일오버 발생(수동 페일오버)

```bash
SENTINEL FAILOVER <master name>
```

센티널에 접속하여 위의 커맨드를 사용하면 페일오버를 바로 발생시킴

주요 목적 → 센티널과 복제본 노드 간 네트워크 단절 등의 이슈로 인해 페일오버가 실패하진 않는지, 센티널에 연결된 애플리케이션의 커넥션이 정상적으로 롤 체인지된 마스터에 연결되는지 등의 정보를 확인할 수 있다.

1. 마스터 동작을 중지시켜 페일오버 발생(자동 페일오버)

```bash
$ redis-cli -h <master-host> -p <master-port> shutdown
```

위의 명령은 마스터 노드의 프로세스를 셧다운 시키는것

직접 마스터 노드에 장애를 발생시킨 뒤 페일오버가 잘 발생하는지 확인함으로써 마스터의 상태가 정상이 아닐 경우 센티널에서 이를 인지할 수 있는지 확인할 수 있다.

**센티널은 주기적으로 마스터 노드에 PING을 보내 응답이 정상적으로 돌아오는지 확인함으로 마스터 인스턴스의 상태를 파악하는데, sentinel.conf에 지정한 down-after-milliseconds 시간 동안 마스터에서 응답이 오지 않으면 마스터의 상태가 정상적이지 않다고 판단해 페일오버를 트리거 함(기본값은 30초)**

```bash
sentinel> SENTINEL SET mymaster down-after-milliseconds 1000
OK
```

- 위와같은 커맨드로 down-after-milliseconds 값을 변경할 수 있다.

### 센티널의 자동 페일오버 과정

1. 마스터의 장애 상황 탐지
2. sdown, odown 실패 상태로 전환
    1. sdown = subjectly down, 즉 주관적인 다운 상태를 의미
3. 이후 다른 센티널들에게 장애 상태 소식을 전파
4. 장애 상태 소식을 받은 센티널들은 교차검증(나도 같은지)
5. 자신을 포함해 쿼럼 값 이상의 센티널 노드에서 장애를 인지한다면 마스터의 상태를 odown 으로 변경
    1. odown이란 objectly down, 즉 객관적인 다운 상태가 됐음을 의미

- 위의 과정은 마스터에 대해서 이루어지는 것이고 센티널은 복제본 노드에 장애가 발생하면 sdown으로 플래깅을 하고 전파를해서 odown으로 변경하진 않는다.

### 복제본 선정 후 마스터로 승격

- 과반수 이상의 센티널이 페일오버에 동의했다면 리더 센티널은 페일어보를 시도하기 위해 마스터가 될 수 있는 복제본을 선정한다.
1. redis.conf 파일에 명시된 replica-priority가 낮은 복제본
2. 마스터로부터 더 많은 데이터를 수신한 복제본
3. 2번 조건까지 동일하다면, runID가 사전 순으로 작은 복제본
